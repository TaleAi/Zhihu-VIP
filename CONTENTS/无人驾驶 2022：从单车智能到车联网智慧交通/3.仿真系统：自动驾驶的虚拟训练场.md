## 3.仿真系统：自动驾驶的虚拟训练场
如果一个成年人想开车上路，就必须先去驾校经过一系列的严格训练，然后通过多项科目考试之后才能取得正式上路的资格。那么对于自动驾驶汽车来说，是不是也要经历类似的过程呢？


答案是肯定的。


在上一讲我们提到，自动驾驶系统是一环扣一环，从目标检测到行为规划再到控制系统，任何一环出现问题都有可能导致车毁人亡的事故，因此在进行大量的测试前，自动驾驶汽车是绝对不可以上路的。**那么自动驾驶系统的测试是如何进行的呢？**


看到这里肯定有人会说，你把汽车放到无人的测试场地里去验证不就好了吗？


不错，这的确是一种办法，但因其较高的研发成本并不适合初期团队。首先，租用场地本身就是一笔昂贵的花费，拿美国著名的测试场地 Transportation Research Center 来说，一天的租赁费用高达数千美金。其次，测试需要投入相关的测试人员与安全人员，这一步也是需要相当客观的费用。在产品初期可能每天都会有许多重大问题的发现，若每次都到实际场地去测验解决，恐怕资金会快就会捉襟见肘。


所以为了能在初期高效、低廉地测试自动驾驶系统，工业界与学术界往往都采用**自动驾驶的虚拟训练场——仿真软件系统，** 一个可以低廉地模拟困难测试场景[[1]](#ref_1) , 解决路测单一变量控制问题的大杀器。


**一、这个「仿真系统」究竟是何方神圣？**
----------------------


仿真软件系统，顾名思义，就是**模仿真实世界所构造的虚拟软件系统**。它是从软件层面对无人驾驶的软件架构研发、软件功能测试和路前测试的重要工具。各位看过**《黑客帝国》**的观众们一定都还记得，主角尼欧在开始真正冒险之前，先被放入了一个虚拟创建的道馆和墨菲斯进行了一场酣畅淋漓的训练，这个道馆所处的世界在一定程度上就可以被当作仿真系统。


如下图所示，一辆黑色的虚拟的无人汽车通过游戏引擎的渲染被构造了出来，进行跟车测试。**它与真实世界的无人车一样**，装备着各种各样的传感器，拥有全套的智能驾驶系统。工程师们可以像搭积木一般在其内有针对性地构建出罕见、困难的测试场景(例如图中所示，在狭窄的道路上，我们的无人车要高效、安全地与前方的红车保持好距离）。


与真实世界不一样的是，**在仿真系统里，无人汽车所有接受的信息都来自游戏引擎渲染出来的虚拟世界，**而且它的测试几乎是不需要任何财力投入的——毕竟只需要敲几行代码便可搞定一切。


![img](https://pic1.zhimg.com/v2-c6f61ef2d9fbb6d686246adc01e47b20.webp)

正是因为仿真软件系统高度的模拟性与效率，它甚至已经成为了重要的法律合规工具。在 2017 年，美国宣布不同级别的自动驾驶车辆在进行路测前，需要满足在仿真系统里积累一定的安全行驶里程数[[2]](#ref_2) 。


现在我们对仿真系统有了一个大概的认知，**那么在仿真里构建一个测试场景需要哪些模块/步骤呢？**


**二、再探仿真软件系统**
--------------


大致来讲，一套完整的仿真测试可以划分为**场景仿真**、**交通流仿真**、**传感器仿真**与**驾驶系统耦合**几大子模块。


![img](https://pic2.zhimg.com/v2-703acf69bb12d13536adb114e3a7fefe.webp)

我们要想无人车可以在仿真中跑起来，就要先给它设计好道路。所以第一步就是生产一组符合高精地图的路网数据，常用的一个软件是 Mathoworks 旗下的 RoadRunner. 


![img](https://pic4.zhimg.com/v2-2530f2fc8519f3eb7b4b200b372fc708.webp)

该软件会制定好道路的拓朴结构、标定道路线与 3D 物体，然后再放到常见的渲染引擎例如 UE4 里进行场景渲染。如下图所示，原本「朴素」的道路设计图在渲染引擎的作用下变得更接近真实世界的场景。


![img](https://pic3.zhimg.com/v2-7a4a3e206c26a9876e3f95359decbe0e.webp)

![img](https://pic4.zhimg.com/v2-a05140c668392ff73565f64dbb3472c4.webp)

道路创建好之后, 我们需要赋予道路一个趋近真实的交通车流，毕竟我们的无人汽车需要学会与周围汽车安全交互。不同的仿真软件系统产生仿真交通流的方式与模式是不同的， 但整体来说**交通流可以分为两类**。


**第一类是服从随机分布生成的大规模车流，**比如我规定好车道 1 每小时会生成 100 辆类似人类驾驶行为的汽车，它们可能会随机变道、加速减速，以次来测试无人汽车系统的鲁棒性。


**第二类是具有特定行为的动态障碍，**这一类主要是为了测试无人汽车是否能在特定的困难场景做出合理的反应。如下图所示，我们的无人车正打算正常左转，这时前方一辆白色的汽车硬闯红灯，挡在了我们的行驶路线上，无人车必须检测到该车并对该异常情况做出安全反应。


![img](https://pic4.zhimg.com/v2-74fa1e9e4d069c1be44c42904727f5dd.webp)

![img](https://pic3.zhimg.com/v2-fb973fab804b4f2d259824f4df1263bb.webp)

有了道路和交通流后，无人车需要具备相应的传感器才能接受这些周围环境的信息进而传送给驾驶系统。现在比较流行的仿真软件都有着很完备的仿真传感器，它们根据现实生活中的传感器参数与模型构造出虚拟世界里的传感器（一般包括激光雷达、相机、声波雷达、GNSS、IMU 等等）。如下图所示，左边是仿真软件里激光雷达收集到的信息，右边是同一时刻仿真相机里收集到的场景照片。


![img](https://pic2.zhimg.com/v2-6669269d7792e0e341f17361b0c92215.webp)

![img](https://pic4.zhimg.com/v2-f09689fb2f6382396f28c8a5f0359236.webp)

当传感器收集到各式各样的环境信息后，就要传送给我们的驾驶系统进行处理，驾驶系统运算过后会控制虚拟环境里无人车执行相应行动，与仿真世界进行交互。仿真世界会因为无人车的举动而产生变化，传感器会根据这个变化更新收集到的数据再次传给系统，以此不停地循环。


仿真软件与驾驶系统之间的耦合很多时候是通过数据桥（ROS-Bridge)[[3]](#ref_3) 进行数据传输，一个比较经典的例子是开源仿真软件 CARLA[[4]](#ref_4) 与开源自动驾驶系统 Autoware 的耦合，如下图所示, 左下角是仿真传感器收集到的相机数据，右侧是 Autoware 处理该数据后得到的周围环境分析图。


![img](https://pic4.zhimg.com/v2-1617354c355f00ede353e278cdc634d6.webp)

**三、仿真系统哪家强？**
--------------


上文我们提到过，仿真软件系统并不是一家独大，就如同我们电脑的操作系统有 windows, linux 和 MacOS 一般，市面上相对成熟的仿真系统也是百家争鸣，下面就让我来列举其中赫赫有名的几家（排名不分先后）。


![img](https://pic1.zhimg.com/v2-64bd30518b9e899782c0b7059761ca36.webp)

**SUMO**[[5]](#ref_5) **，**全称 Simulation of Urban Mobility， 是一款流行的交通仿真软件。


与一般的只能控制交通流的宏观交通仿真不同，它是基于纯粹微观的交通模拟，可以控制每一辆车的速度、出发位置、加速度、变道等等，有许多强化学习的实验都是基于该平台进行的。SUMO 能够**创造较大规模且趋近逼真的交通环境**，它对自动驾驶的模拟更多是集中在控制与规划层面以及分析无人车对交通流的影响。当然，它本身也有一些显著的限制，比如**缺乏视觉感知模块，汽车动态模型与控制系统过于简单**等等。


![img](https://pic3.zhimg.com/v2-7b5c05766f819d6d5dd60bc34ca05847.webp)

![img](https://pic3.zhimg.com/v2-ac16f6c91416fd0b9bfdd7cfc7d50fd3.webp)

**CARLA** 是一款开源、拥有活跃社群的自动驾驶仿真软件，也是目前人气最高的仿真系统之一，最初由英特尔实验室与丰田研发中心的工程师合力研发。


它采用的是服务器端-客户端架构，服务器端（Server)通过大量代码运算构造虚拟的世界，并通过 UNREAL 游戏引擎(最终幻想 7 重制版就是由它创造的）渲染出接近真实的画面从而让这个世界而可视化。而客户端可以理解为用户所写的代码脚本（一般为 Python), 通过脚本可以控制这个虚拟世界的变化，构造出用户想要的测试。换句话说，客户端是用来下命令的，服务器端则是执行和结果呈现者。


CARLA 的优势十分明显，它具有真实的渲染效果，拥有良好的汽车动态模型、接近真实的传感器模型与具备物理特性的驾驶环境，允许开发者进行端到端的开发，从视觉感知到复杂的控制系统一应俱全。当然，它也不是完美的，其中最显著的一个缺点就是它模拟出的交通环境并不是十分真实，而且用户很难控制背景车流（即我们无人车之外的汽车）的行为模式。


为了克服这个缺点，CARLA 和上面提到的 SUMO 进行了深度合作**，**提出了**协同仿真**的概念，让二者进行优势互补。


![img](https://pic1.zhimg.com/v2-88c885f2225e1b1db57f34bd9e8cf50a.webp)

![img](https://pic1.zhimg.com/v2-3c837c29e072e8146c0c074fcf9c5875.webp)

**AirSim**[[6]](#ref_6)  是由微软开发的一款开源仿真软件。它的名字之所以带 Air，是因为它除了无人汽车，还可以对无人机进行仿真模拟。


类似于 CARLA，AirSim 使用 UNREAL 引擎进行环境渲染，拥有逼真的传感模拟、交通模拟和车辆动态模型，它提出了一个「一站式 AI」的理念，通过提供 Python, C++等多语言的接口，允许使用者很方便地将各种机器学习工具与该仿真软件结合，进行训练与测试。


和 CARLA 相比较，它的渲染更为真实，驾驶环境更为复杂，甚至还支持外接方向盘来控制仿真中无人车。但由于它的模拟是无法控制单位步长的，导致结果不可复现，这也是它现在的一大缺点。比如说，我想比较两个系统谁更稳定，但是每次跑同一张地图时周围交通环境都无法控制成一模一样，这样比出来的结果肯定是说服力不足的。


![img](https://pic3.zhimg.com/v2-7735dfdd346119622daecfd948b8bc80.webp)

![img](https://pic1.zhimg.com/v2-8ec4aa5dc7a5c740120a092438e3ab28.webp)

除了上述三款仿真软件，市面上还有许多其他优秀的仿真系统，每一款仿真软件都有自己的垂直领域和优势，下面这张图便展示了自动驾驶领域最常见的仿真软件以及它们所专注的领域。**由于没有一款仿真软件可以制霸全部细分领域，联合仿真将会成为一个新的热门趋势。**


![img](https://pic3.zhimg.com/v2-ea132e187a9263ba60dd06c14cdf7d59.webp)

**四、小结**
--------


经过这一章的讲述，我们对自动驾驶的仿真已经有了一个大致的了解。在最后要说明的一点是，仿真测试虽然十分强大，但其结果永远只能作为评价自动驾驶是否合格的指标之一，要想让无人汽车真的上路行驶，必须还要经过成千上万次的实地测试。


备案号:YX01APK9jDXMmP4pY


参考
--

1. [^](#ref_1_0)一种高精地图的生成方法和装置，王磊，-9-10，CN201910438653.0，G01C21/32(2006.01)I; G01C21/30(2006.01)
2. [^](#ref_2_0)H.R.3388 - SELF DRIVE ACT, 2017, House - Energy and Commerce | Senate - Commerce, Science, and Transportation,
 <https://www.congress.gov/bill/115th-conkgress/house-bill/3388>
3. [^](#ref_3_0)ROS/ROS bridge for Carla system, 
 <https://github.com/carla-simulator/ros-bridge>
4. [^](#ref_4_0)A. Dosovitskiy, G. Ros, F. Codevilla, A. Lopez, andV. Koltun. &nbsp;CARLA: An open urban driving simulator. InCoRL, 2017. 2, 3
 <https://github.com/carla-simulator/ros-bridge>
5. [^](#ref_5_0)P. Lopez, M. Behrisch, L. Bieker-Walz, J. Erdmann and Y. Fl, Microscopic Traffic Simulation using SUMO. ITSC, 2048
6. [^](#ref_6_0)S. Shah, D. Dey, C. Lovett, and A. Kapoor, Airsim: High-fidelity
visual and physical simulation for autonomous vehicles, in Field
and Service Robotics, 2017

###### 2021-08-03 06:15
