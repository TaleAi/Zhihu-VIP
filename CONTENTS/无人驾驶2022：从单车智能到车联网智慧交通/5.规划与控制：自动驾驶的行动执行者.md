## 5.规划与控制：自动驾驶的行动执行者
我们人类在开车时，如果要做变道或者加速减速，一般会先观察周围的车辆，推测附近车辆的行驶轨迹，然后在心中描绘出自己大概要开的轨迹，最后，控制油门与方向盘实际执行该轨迹。在本章中，我们将讨论自动驾驶系统中赋予相似能力的模块：决策规划与控制。  

如图 1 所示，该模块可再被细分为路线规划 (route planning)，行为规划 (behavioral planning)，运动规划 (motion planning)，以及反馈控制 (feedback control)。这种划分方法有效地将自动驾驶车辆决策规划与控制这样一个复杂问题从全局到局部进行了合理的分解。这可使得每个模块专注解决单一的问题，简化庞杂软件系统的开发工作，同时实现各模块并行开发，提高开发效率。在接下来的章节中，我们将详细介绍各个模块。


![img](https://pic3.zhimg.com/v2-becad0a8fe340391fdcb79ea6a153f65.webp)

一、路线规划
------


![img](https://pic3.zhimg.com/v2-46f5a0d9a15237dd6cd439db17a63d54.webp)

当我们驾车前往不熟悉的目的地时，上车后第一件事便是使用导航地图。在自动驾驶车辆软件系统中对应于这部分功能的模块便是路线规划 --- 从全局上指导自动驾驶车辆按照导航路线从起始地到目的地。这里的路线规划虽然一定程度上类似于传统的导航，但自动驾驶车辆通常使用高精度地图 --- 精度更高、数据维度更多的电子地图。精度更高体现在高精地图上的物体位置和其实际位置误差可以精确到厘米级别；数据维度更高指的是除了道路信息之外，高精地图还包含大量辅助行车的周边交通信息。


这些信息可以分为两类。第一类是道路数据，比如车道线的位置、类型、车道的宽度、坡度和曲率等。第二类是车道周围的固定对象信息，比如交通标志、红绿灯、车道限高、下水道口、障碍物、防护栏、路边地标等基础设施信息。在此基础上，高精地图的数据更新频率比传统导航地图快很多。


自动驾驶路线规划所考虑的不仅仅是路径的长短和堵塞情况，还需要考虑自动驾驶车辆执行某些特定行为的难易程度。比如，路线规划算法可能会尽量避免在短距离内进行换道。出于安全考虑，自动驾驶车辆的规划控制算法需要的换道空间比人类驾驶员所需要的更大。从安全第一的原则出发，自动驾驶车辆的路线规划模块可能会给需要换道的路径赋予更高的代价。


自动驾驶车辆的路线规划问题可以被抽象成一个在有向带权图上的最短路径搜索问题，经典的 Dijkstra 或 A\* 等算法可被用于解决此类问题。在实际问题中，更重要的往往不是路线规划算法的选择，而是如何设置采取某条路径的代价。类似于对换道代价的考虑，需要进行无保护左转的路径也应该被提高代价，因为无保护左转对于保守的自动驾驶车辆而言是非常耗时的行为。


![img](https://pic3.zhimg.com/v2-deb0c5de6bfe9f125d16f54c699c30e7.webp)

二、行为规划
------


![img](https://pica.zhimg.com/v2-f734557c6a4a18bf2607414aaac46411.webp)

路线规划模块所输出的目标车道会被下游的行为规划模块所使用。该模块回答的是诸如「我应该变道吗？」、「黄灯该减速还是加速？」、「是时机左转了吗？」、「应该绕过违停车辆吗？」等问题。除了接收来自路线规划的结果，行为规划模块还需要许多重要信息。


* 当前车身状态：位置、速度、朝向、所在车道等。
* 历史信息：上一次决策是什么？是跟车、停车、转弯、还是换道？
* 周边障碍物信息：周边其他车辆、自行车、或行人所在的车道、位置、速度以及在短时间内对他们意图和轨迹的预测。
* 周边交通信息：车道线是否允许换道？路边是否有 stop sign？红灯的时候允许右转吗？限速是多少？

考虑以上信息后，行为规划模块给出行为层面的决策，包括在道路上的正常跟车，在遇到交通灯和行人时的等待避让，以及在路口和其他车辆的交互通过等。例如，路线规划模块要求自动驾驶车辆保持在当前车道行驶，当感知到前方有一辆正常行驶的车辆时，行为规划的一个决定便很可能是下达跟车命令。  




![img](https://pica.zhimg.com/v2-12926d0c28075599dc5645d64509c248.webp)

实现行为规划模块的方法相对较多，而且没有非常严格的规则要遵循。由于该模块需要考虑多种不同类型的信息和非常局部的交通规则，该问题很难用一个数学模型解决。但其设计理念大致可以总结为两点：


1. **合理性：**自动驾驶的合理性建立在两个基础之上 --- 交通法规和驾驶经验。其中，交通法规的优先级要高于驾驶经验。交通法规需要考虑的内容包括：靠右车道行驶；不能超速；换道超车前应该提前开启转向灯；对于感知到的交通信号灯和交通标志，应遵守其内容行驶；出现任何危险情况，应该能够果断地执行紧急制动等。驾驶经验需要考虑的内容主要包括：尽量保持在原车道，避免随意变道；城市路段行驶时，不应随意加减速，而应该平稳驾驶提高乘客体验，对于前车行驶缓慢而条件允许的情况应该果断超车等。
2. **实时性：**任何自动驾驶系统的行为规划都应该是实时的，从而快速适应不断变化的复杂交通场景。

在 DARPA 自动驾驶车辆竞赛中，Stanford 团队为不同的行为设计了相应的代价和有限状态机 (finite state machine) 来实现不同行为间的切换。类似地，CMU 的自动驾驶车辆 Boss 通过计算分析车道之间的空隙，并且按照一定规则和一些阈值决定换道行为的触发。其他很多的参赛队伍也编写了规则来决定自动驾驶车辆的驾驶行为。虽然概率决策模型在学术界渐渐流行，但基于确定性规则的规划方法仍然是工业界的主流。  

**三、运动规划**  

在自动驾驶车辆系统设计中，行为规划模块有时候被设计成独立的逻辑模块，有时候被融合在了运动规划模块中，以实现这两个模块间更紧密的配合。


![img](https://pica.zhimg.com/v2-89f219208d37626aa3f6d01f1b94f795.webp)

确定行为决策后，运动规划模块计算出实现该目标的可行轨迹。所谓可行轨迹，即在满足自动驾驶车辆本身的限制（比如，车辆无法原地旋转、车轮转角有限、车辆具有一定体积等）和环境约束（例如周围其他车辆和行人）的条件下，实现决策目标的最佳行进路径。相对于行为规划模块，运动规划模块解决的问题又更具体了一步。


运动规划需要具体地在给出一个短暂时间段内将车辆从当前所处姿态 (pose) 转移至另一个姿态的中间路径点 (waypoints)，包括选择途径哪些路径点，以及到达每个路径点时，自动驾驶车辆需要达到的速度、朝向、加速度，以及车轮转向等。


不仅如此，运动规划还需要保证两点：一是运动的连贯一致性；二是每个路径点所要求的速度、朝向、加速度等可以被下游的反馈控制模块实现 --- 即所规划的路径在物理上是实际可行的。类似的要求也出现在行为规划和运动规划模块间：行为规划模块输出的决策需要能被下游的运动规划模块所实现。理论上，运动规划模块只需要接收来自行为规划模块的决策并计算相应的路径即可。实际上，一般在设计系统时，我们也会同样让感知预测和地图定位结果接入运动规划模块。


这样相对冗余的设计的好处有两点：一方面，如果仅仅依赖行为规划模块传递感知结果，那么在行为规划模块计算完成前出现的新感知物体将会被忽略，给自动驾驶车辆带来安全隐患；二是如果行为规划模块出现了问题，运动规划模块依旧能根据感知预测和地图定位实现最基本的避让，提高了安全性。


因为车辆的运动规划是在二维平面上进行的，比起机械臂等高维空间中的运动规划而言较为简单。从 DARPA 自动驾驶车辆比赛开始，运动规划模块便逐渐成为一个相对独立的模块。随着研究的进展，该模块所需要解决的问题也逐渐明晰：在一定的约束条件下优化某个范围内的时空路径问题。所谓时空路径指的是车辆在一定时间段内行驶的轨迹。该轨迹不仅包含位置信息，还包括整条轨迹的时间信息和车辆姿态 --- 即到达每个位置的时间、速度、以及任何可能的和时间相关的运动变量如加速度、曲率等。


大多数传统的为自动驾驶车辆计算安全轨迹的方法基于以下三种想法之一。第一类是输入空间离散化及碰撞检测，比如格子规划器 (lattice planners) 或者道路对齐元行为 (road-aligned primitives)。这类方法的主要优势是简单有效，特别是在高速场景下。第二类是随机规划 (randomized planning)，比如快速探索随机树 (rapidly exploring random trees, RRT)，其主要优势是快速搜索很大的状态空间，然而计算量较大。第三类是带约束的优化和滚动域控制 (receding-horizon control)。这些方法的主要优势是可获得平滑的路径以及车辆模型被直接编码入轨迹规划中。然而，如果不是凸优化问题，优化方法将收敛到局部最优路径上。


四、反馈控制
------


![img](https://pic1.zhimg.com/v2-2eb9bf2918f7e6cf26eca55fbd5c56fc.webp)

最终，实际控制车辆加减速和转向的是反馈控制模块。在得到运动规划模块给出的轨迹后，控制模块将以非常高的频率不断发送指令调整车辆的速度和方向，以精准实现目标轨迹。PID 控制器（proportional–integral–derivative controller）是常用的反馈控制算法，其基本思想是计算实际运动轨迹和目标运动轨迹之间的误差，然后不断调整车速和转向以使误差减小，从而实现轨迹追踪的功能。  

  

在相对低速的情况下，车辆的**运动学模型**可以被用于车辆控制。给定一个参考路径，PID 控制或者模型预测控制 (model predictive control) 等可以被用于跟随该参考路径。然而，在速度较高或者执行高强度的复杂行为时，我们需要完整的**车辆动力学模型**（包括胎压）和更复杂的控制器。通过这些车辆模型和控制器，我们可以达到很好的轨迹追踪性能，即使是自动驾驶赛车。


控制算法所需要的车辆模型不一定能被显式的数学公式表达出来，所以我们可能需要通过数据学习该动力学模型，这一过程被称为系统辨别 (system identification)。由于路况和车况会随着时间不断改变，在线系统辨别 (online system identification) 或终身系统辨别 (lifelong system identification) 也将是重要的模块。


**五、端到端解决方案**
-------------


上述模块化的自动驾驶车辆软件系统带来了模块之间协调一致的问题，其中最重要的便是模块之间计算结果一致性的问题。本质上，行为规划、运动规划、反馈控制都是在不同的层面解决同一个问题。由于上下游关系的存在，他们的计算结果相互依赖.当冲突出现时，一个普遍的解决冲突的准则是尽可能让上游模块去解决问题迁就下游模块，而不是去尝试下游模块的极限。


如果说将自动驾驶车辆感知和不同层级的决策规划与控制分离的模块化实现是一个极端，那么端到端 (end-to-end) 的方案则是另一个极端。端到端指的是直接将车辆状态和周围环境信息映射到对自动驾驶车辆的控制信号，该映射通常由神经网络来完成。这方面最早的尝试可以追溯到 1989 年的 ALVINN (Autonomous Land Vehicle in a Neural Network)。


![img](https://pic3.zhimg.com/v2-47025ed292c4417954763ff9558a2358.webp)

该工作的输入包括前方道路的视频数据、激光测距仪器数据、以及前一张图像中路面和非路面的相对亮度，输出是一个指示前进方向的向量以及输入到下一时刻的亮度反馈。在训练 ALVINN 时，其目标输出被设为对应于能让车辆行驶到前方 7 米处的道路中心的方向。此外，在训练过程中他们使用了大量合成的道路数据，用于提高该模型在新环境中的性能。该模型成功地以 0.5 米每秒的速度开过一个 400 米长的道路。  




![img](https://pic2.zhimg.com/v2-f0baf087415ea7f4c13d5f1374ae9120.webp)

近年来，比较有影响力的工作是 2016 年 NVIDIA 开发的 PilotNet。该模型使用卷积层和全连接层从输入图像中抽取特征，并给出方向盘的转向角。该系统以人类驾驶员的转向角为信号，训练网络的参数。路测结果表明 PilotNet 可以在不同的驾驶条件下将车保持在车道中。为了理解哪些物体决定了网络的输出，他们还可视化了最影响网络决策的像素点。可视化结果表明，网络将注意力放在了路标、路沿、以及其他车辆，虽然我们没有显式地要求网络关注这些地方。


六、决策规划与控制的难点与挑战
---------------


![img](https://pic2.zhimg.com/v2-229906bf1218440a7e7f68bc8ccf2590.webp)

2018 年 3 月，在美国亚利桑那 (Arizona) 州，Uber 的自动驾驶车辆以 70km/h 的速度撞上一名 49 岁女子并致其身亡。事后，美国国家运输安全委员会公布了车祸的细节。文件显示，Uber 的自动驾驶车辆在发生碰撞前 5.6 秒就检测到了行人，但将其错误识别为汽车，而后又将其归类为「其他物体」。系统对物体的分类发生了混乱，在「汽车」和「其他」之间摇摆不定，浪费了大量宝贵时间，车辆也因此没有及时刹车。当时车上的安全员也在观看电视节目而未采取任何措施，最终酿成惨祸。


2021 年 3 月 11 日，一辆特斯拉 Model Y 在美国底特律 (Detroit) 西南部一个十字路口撞上一辆白色卡车。这已经不是特斯拉第一次无法正确分类白色大卡车的侧面了。在之前一次比较闻名的事故中，特斯拉将白色卡车的侧面与白色的天空混淆了。


这些事故提醒我们当前感知算法并未达到自动驾驶所要求的精确度和可靠性，所以提高感知算法的表现应该会改善这些状况。但是，感知算法的难点不是本章所讨论的重点，而且我们很难保证所有特殊情况都被考虑了。这里我们要讨论的是，模块化的自动驾驶软件系统的一个弊端：一旦上游模块精度不够，下游模块会将错就错。作为比较，人类司机开车的时候感知和规划是相辅相成的。


![img](https://pic3.zhimg.com/v2-5d9dba42dd1821ab5d47376fa34d12e8.webp)

我们的规划是依赖于感知的。如果我们阴雨天或者下大雪的夜晚开车，由于看不清路况，我们会选择小心翼翼地缓慢行驶、与其他车辆保持更大的距离。若积雪未及时铲除，我们将紧跟前车的轮印并且远离马路边缘。从支路并入主路时，如果停在 stop sign 旁无法看清主路来车，我们会选择再往前开一些以开拓视野。这些例子都说明，我们不仅知道感知到了什么，而且知道对感知结果的不确定性，甚至知道「我们不知道什么」。


![img](https://pic2.zhimg.com/v2-66691e39e4d20e6bcca75703ac63a1b6.webp)

以前，基于深度学习的感知算法并未考虑模型的预测不确定性，规划模块无从分辨它得到的信息是准确的预测还是「瞎猜」。现在关于贝叶斯深度学习的研究正努力将可靠的不确定性估计融入深度学习模型中。让我们乐观地假设关于感知算法的不确定性估计问题会被解决，那么规划决策算法应该如何利用这些信息？


另一方面，我们的感知也是依赖于规划决策的。上述 stop sign 并入主道的用于此处：假如当前决策是右转进入主道，我们将把注意力重点放在将要进入的那一条车道上是否有车。再比如，当我们决定向左变道，我们的注意力将集中在左（后）方车辆以及我们与前车的距离上。夜间行车时，我们将主要关注各种信号灯。因此，除了车辆轨迹的规划，我们还应进行感知层面的规划：对接下来行动有关键影响的感知信息容不得半点含糊，而其他不相关的环境信息可容忍比较大的不确定性。这类似于人类将注意力放在重点区域，而对非重点区域则使用物理直觉预测。


要达到人类司机一样的智能驾驶行为，决策规划算法需要是协同交互的。自动驾驶车辆需要推断其他驾驶员的意图并整合到规划框架中，从而在车辆之间无法互相联网沟通的情况下也能得到合理的协同决策。同时，自动驾驶车辆的意图也应该容易地被其他驾驶员猜到。


在 Waymo 自动驾驶车辆试运营后，记者发现变道是 Waymo 车辆的一个问题：当试图驶入拥挤的车道时， Waymo 车辆似乎缺乏人类司机预测其他司机行为的能力。 左转弯进入主干道的过程会慢得令人痛苦。协同交互的行为规划需要对道路上其他实体（人或物）未来的行为或轨迹进行预测，并与其他驾驶员进行「协商博弈」，最终达到大家都满意的行为规划。


在真实交通状况中，不同实体之间的互动行为是错综复杂的，而且可能会出现视线遮挡的情况（比如，左转时对面的车也希望左转并部分遮挡了你观察来方车辆的视线），因此行为和轨迹预测本身就很困难了，而在此基础上的行为规划更是难上加难。


如何处理违章行为？按理说，交通规则应该作为规划决策算法不可逾越的限制条件。但是，实际上我们为了安全不得不违反交通规则，或者处理其他驾驶员违规驾驶的情况。例如，自动驾驶车辆需要绕过路边违停车辆。再比如，再自动驾驶车辆靠近红绿灯时，其他驾驶员发现自己开错道了希望改到自动驾驶车辆所在车道，这时应该减速谦让吗？在听到警车、救护车、消防车鸣笛时，所有车辆应该让出道路来，这时也可能难免要暂时违章。如果违反的话，哪些可以违反？多大程度的违反？


![img](https://pic1.zhimg.com/v2-1da1bd11bcaf8f08373dbcacb196f9b6.webp)

人类拥有组合泛化 (compositional generalization) 的能力：将有限的已知事物应用于无限种情景的能力。语言便是一个很好的例子，我们可以使用 26 个英文字母组合出各种意思。当我们学车时，我们仅仅学习了一些常见情境下基本的决策和控制，而习得技能后，我们便能将这些技能在其他情形下随意组合利用。囊括自动驾驶车辆可能遇见的所有情景是很困难的，但若能在学习过程中将情景分解成可被重复利用的「元素」，日后遇到新情景时便可以辨认出「这不过是旧元素的新组合」，我们便可以应付指数级的情景。


备案号:YX01APK9jDXMmP4pY

